---
import { getImage } from 'astro:assets';

interface Props {
  src: ImageMetadata;
  alt: string;
  class?: string;
  width?: number;
  height?: number;
}

const { src, alt, class: className, ...rest } = Astro.props;

const placeholder = await getImage({ src, width: 20, format: 'webp' });
const full = await getImage({ src, format: 'webp' });

const aspectRatio = src.width / src.height;
---

<div class:list={[className]} style={`position:relative; aspect-ratio:${aspectRatio}; overflow:hidden;`}>
  <img
    src={placeholder.src}
    alt=""
    aria-hidden="true"
    style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:blur(20px); transform:scale(1.05);"
  />
  <img
    src={full.src}
    width={full.attributes.width}
    height={full.attributes.height}
    alt={alt}
    loading="lazy"
    decoding="async"
    class="blur-image-full"
    style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 0.5s ease;"
    onload="this.classList.add('loaded')"
    {...rest}
  />
</div>

<style>
  .blur-image-full.loaded {
    opacity: 1 !important;
  }
</style>
